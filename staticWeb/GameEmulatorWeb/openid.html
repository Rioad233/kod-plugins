<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>自动获取openId</title>
    <!-- 支持 微信,QQ -->
    <script>
        (function (){
            var openIdUtils = {
                isWeiXin:function(){
                    var ua = navigator.userAgent.toLowerCase();
                    var isWeixin = ua.indexOf('micromessenger') != -1;
                    if (isWeixin) {
                        return true;
                    }else{
                        return false;
                    }
                },
                isQQ:function(){
                    var ua = navigator.userAgent.toLowerCase();
                    var isqq = ua.indexOf(' qq') != -1;
                    if (isqq) {
                        return true;
                    }else{
                        return false;
                    }
                },
                getSearch: function () {
                    var search = window.location.search;
                    return this.getSearchByStr(search);
                },
                getSearchByStr:function(search){
                    if (search) {
                        search = search.substring(1);
                    } else {
                        return {};
                    }
                    var strsz = search.split("&");
                    var map = {};
                    for (var i=0; i<strsz.length; i++){
                        var strs = strsz[i];
                        if (strs.indexOf("=") != -1) {
                            var tempsz = strs.split("=");
                            var tempkey = tempsz[0];
                            var tempvalue = tempsz[1];
                            map[tempkey] = decodeURIComponent(tempvalue);
                        }
                    }
                    return map;
                },
                toOpenPage:function(openId){
                    var that = this;
                    var url = localStorage.getItem("openIdHdUrl");
                    var wh = url.indexOf("?");
                    var jh = url.indexOf("#");
                    var left = url;
                    var searchStr = "";
                    if(wh != -1){
                        left = url.substring(0,wh)
                        if(jh != -1){
                            searchStr = url.substring(wh,jh)
                        }else{
                            searchStr = url.substring(wh)
                        }
                    }else if(jh != -1){
                        left = url.substring(0,jh)
                    }
                    var right = "";
                    if(jh != -1){
                        right = url.substring(jh)
                    }
                    var map = that.getSearchByStr(searchStr);
                    if(that.isQQ()){
                        map.qqOpenId = openId;
                    }else if(that.isWeiXin()){
                        map.wxOpenId = openId;
                    }
                    var count = 0;
                    var newSearch = "";
                    for(var key in map){
                        if(count == 0){
                            newSearch += "?";
                        }else{
                            newSearch += "&";
                        }
                        count++
                        newSearch += key + "=" + map[key];
                    }
                    var newUrl = left + newSearch + right;
                    window.location.href = newUrl;
                },
                init:function(){
                    var that = this;
                    var params = that.getSearch();
                    if(that.isQQ()){
                        var hash = that.getSearchByStr(window.location.hash);
                        if(hash.access_token){
                            alert(window.location.href);
                            return;
                        }
                        if(params.openid){
                            that.toOpenPage(params.openid);
                            return;
                        }
                    }else if(that.isWeiXin()){
                        if(params.code){
                            that.ajaxGet("http://hm10735.h61.hmie.cn/php-file/game-emulator/getOpenId.php?code="+params.code,function(res){
                                if(res.flag){
                                    that.toOpenPage(res.data);
                                }else{
                                    alert(res.msg);
                                }
                            });
                            return;
                        }
                    }
                    if(!params.url){
                        alert("缺少回调地址");
                        return;
                    }
                    localStorage.setItem("openIdHdUrl",params.url);
                    if(that.isQQ()){
                        window.location.href = "https://graph.qq.com/oauth2.0/authorize?response_type=token&client_id=101978084&redirect_uri="+encodeURIComponent(window.location.href);
                    }else if(that.isWeiXin()){
                        var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7f56bde55966b1c9&redirect_uri="+encodeURIComponent(window.location.href)+"&response_type=code&scope=snsapi_base#wechat_redirect";
                        window.location.href = url;
                    }
                },
                jsonp:function (url,callback) {
                    window.callback = function (res) {
                        callback(res);
                    }
                    var script = document.createElement("script");
                    script.type = "text/javascript";
                    script.src=url;
                    var head = document.getElementsByTagName("head")[0];
                    head.appendChild(script);
                    setTimeout(function () {
                        head.removeChild(script);
                    },10);
                },
                ajaxGet:function(url,callback){

                }
            }
            openIdUtils.init();
        })()
    </script>
</head>
<body>
</body>
</html>
